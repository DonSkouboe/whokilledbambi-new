<!DOCTYPE html>
<html lang="da">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WhoKilledBambi - Det Danske Strygerensemble</title>
    <meta name="description" content="Who Killed Bambi - Et moderne strygerensemble der udforsker grænserne mellem det akustiske og elektriske. Booking, nyheder og koncerter." />
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,500;1,600;1,700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              serif: ['"Cormorant Garamond"', 'serif'],
              sans: ['"Lato"', 'sans-serif'],
            },
            colors: {
              wkbPaper: '#F2EFE9',
              wkbInk: '#1A1C1B',
              wkbCoral: '#FF6B4A',
              wkbSage: '#94A388',
            },
            animation: {
              'spin-slow': 'spin 20s linear infinite',
              'marquee': 'marquee 60s linear infinite',
              'breathe': 'breathe 8s ease-in-out infinite',
              'pulse-color': 'pulseColor 10s ease-in-out infinite',
              'pulse-slow': 'pulse 8s cubic-bezier(0.4, 0, 0.6, 1) infinite',
            },
            keyframes: {
              marquee: {
                '0%': { transform: 'translateX(0%)' },
                '100%': { transform: 'translateX(-50%)' },
              },
              breathe: {
                '0%, 100%': { transform: 'scale(1)', opacity: '0.8' },
                '50%': { transform: 'scale(1.1)', opacity: '1' },
              },
              pulseColor: {
                '0%, 100%': { backgroundColor: '#FF6B4A' },
                '33%': { backgroundColor: '#94A388' },
                '66%': { backgroundColor: '#C48B55' },
              }
            }
          }
        }
      }
    </script>

    <style>
      body {
        margin: 0;
        padding: 0;
        background-color: #F2EFE9;
        color: #1A1C1B;
        font-family: 'Lato', sans-serif;
        overflow-x: hidden;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }
      
      .noise {
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        pointer-events: none;
        z-index: 50;
        opacity: 0.05;
        background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
        mix-blend-mode: multiply;
      }

      h1, h2, h3, h4, h5, h6 {
        font-family: 'Cormorant Garamond', serif;
        font-weight: 400;
      }
      
      .blend-ink {
        mix-blend-mode: multiply;
      }

      .text-editorial {
        letter-spacing: -0.03em;
      }
      
      .fade-in-up {
        animation: fadeInUp 1.2s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        opacity: 0;
      }
      @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(40px); }
        to { opacity: 1; transform: translateY(0); }
      }

      html { scroll-behavior: smooth; }
      ::selection { background: #FF6B4A; color: white; }

      ::-webkit-scrollbar { width: 6px; }
      ::-webkit-scrollbar-track { background: #F2EFE9; }
      ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }
      ::-webkit-scrollbar-thumb:hover { background: #1A1C1B; }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect, useRef } = React;
      
      const ROUTES = new Set(['home', 'news', 'about', 'plus', 'calendar']);

      const getBasePath = () => {
        const path = window.location.pathname || '/';
        if (path.endsWith('/index.html')) {
          const base = path.slice(0, -'/index.html'.length);
          return base.endsWith('/') ? base : base + '/';
        }
        if (path.endsWith('/')) return path;
        const last = path.split('/').pop() || '';
        if (last.includes('.')) {
          return path.replace(/\/[^/]*$/, '/') || '/';
        }
        return path.replace(/\/[^/]*$/, '/') || '/';
      };

      const basePath = getBasePath();

      const queryParams = new URLSearchParams(window.location.search);
      const previewMode = queryParams.get('preview');
      const redirectPath = queryParams.get('redirect');

      const getPageFromPath = () => {
        let path = redirectPath ? decodeURIComponent(redirectPath) : (window.location.pathname || '');
        if (basePath !== '/' && path.startsWith(basePath)) {
          path = '/' + path.slice(basePath.length).replace(/^\/+/, '');
        }
        if (path === '/' || path === '') return 'home';
        if (path.endsWith('/index.html') || path.endsWith('index.html')) return 'home';
        const slug = path.replace(/^\/+/, '').replace(/\/+$/, '');
        if (!slug || slug.includes('.') || slug.includes(':')) return 'home';
        return slug;
      };
      
      const previewPayload = (() => {
        try { return JSON.parse(localStorage.getItem('wkbPreview') || 'null'); } 
        catch (err) { return null; }
      })();


      const parseImageMeta = (url) => {
        if (!url) return { src: '', fx: 50, fy: 50, z: 100 };
        const [base, hash] = url.split('#');
        if (!hash) return { src: base, fx: 50, fy: 50, z: 100 };
        const raw = hash.startsWith('wkb=') ? hash.slice(4) : (hash.startsWith('focus=') ? hash.slice(6) : '');
        if (!raw) return { src: base, fx: 50, fy: 50, z: 100 };
        const parts = raw.split(',').map((p) => p.trim());
        const fx = parseInt(parts[0] || '50', 10);
        const fy = parseInt(parts[1] || '50', 10);
        const z = parseInt(parts[2] || '100', 10);
        return {
          src: base,
          fx: Number.isFinite(fx) ? fx : 50,
          fy: Number.isFinite(fy) ? fy : 50,
          z: Number.isFinite(z) ? z : 100
        };
      };

      const aspectClass = (ratio) => {
        switch (ratio) {
          case '16:9': return 'aspect-video';
          case '21:9': return 'aspect-[21/9]';
          case '3:4': return 'aspect-[3/4]';
          case '1:1': return 'aspect-square';
          case '4:3':
          default: return 'aspect-[4/3]';
        }
      };

      const resolveCtaLink = (value) => {
        if (!value) return '#';
        const raw = value.trim();
        if (/^https?:\/\//i.test(raw)) return raw;
        if (raw.startsWith('/')) return `${basePath}${raw.replace(/^\/+/, '')}`;
        if (raw === 'home') return basePath;
        return `${basePath}${raw}`;
      };

      
      const SUPABASE_URL = 'https://rtblicylmsfhpeggqmlp.supabase.co';
      const SUPABASE_ANON_KEY = 'sb_publishable_7b6MrtzuIoPBz0RiC9YDEg_v6khvC2y';
      const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      // --- ICONS ---
      const ArrowRight = ({ size = 24, className = "" }) => <i className={`ph-bold ph-arrow-right ${className}`}></i>;
      const Music = ({ size = 24, className = "" }) => <i className={`ph-fill ph-music-notes ${className}`}></i>;
      const XIcon = ({ size = 24, className = "" }) => <i className={`ph-bold ph-x ${className}`}></i>;
      const Speaker = ({ size = 24, className = "" }) => <i className={`ph-fill ph-speaker-high ${className}`}></i>;
      const SpeakerOff = ({ size = 24, className = "" }) => <i className={`ph-bold ph-speaker-slash ${className}`}></i>;
      const Loader = ({ size = 24, className = "" }) => <i className={`ph-bold ph-spinner animate-spin ${className}`}></i>;
      const Download = ({ size = 24, className = "" }) => <i className={`ph-bold ph-download-simple ${className}`}></i>;
      const Envelope = ({ size = 24, className = "" }) => <i className={`ph-bold ph-envelope-simple ${className}`}></i>;

      // --- DEFAULTS ---
      const DEFAULT_MEMBERS_DATA = [
        { name: "Anna Sakham Jalving", instrument: "Violin", imageUrl: "https://static.wixstatic.com/media/d3f0ae_0052268835dc494f988a12393faf0619~mv2.jpg/v1/crop/x_733,y_169,w_2037,h_2291/fill/w_500,h_600,al_c,q_85,usm_0.66_1.00_0.01,enc_avif,quality_auto/Presse2022_MatiasBager4103.jpg" },
        { name: "Benedikte Borum Engell", instrument: "Cello", imageUrl: "https://static.wixstatic.com/media/d3f0ae_c7f9ce2cc6754dcb82e6a55eaf998899~mv2.jpg/v1/crop/x_605,y_0,w_2290,h_2625/fill/w_500,h_600,al_c,q_85,usm_0.66_1.00_0.01,enc_avif,quality_auto/Presse2022_MatiasBager4084.jpg" },
        { name: "Mette Dahl Kristensen", instrument: "Bratsch", imageUrl: "https://static.wixstatic.com/media/d3f0ae_a7738640eb22483e8b874292671309ff~mv2.jpg/v1/crop/x_712,y_245,w_2077,h_2380/fill/w_500,h_600,al_c,q_85,usm_0.66_1.00_0.01,enc_avif,quality_auto/Presse2022_MatiasBager4119%20(1).jpg" },
        { name: "Sophia Larsdotter", instrument: "Violin", imageUrl: "https://static.wixstatic.com/media/d3f0ae_f49692885def456daef608186fb0c4c1~mv2.jpg/v1/crop/x_770,y_245,w_2077,h_2380/fill/w_500,h_600,al_c,q_85,usm_0.66_1.00_0.01,enc_avif,quality_auto/Presse2022_MatiasBager4148.jpg" },
        { name: "Mathilde Helding", instrument: "Cello", imageUrl: "https://static.wixstatic.com/media/d3f0ae_93bf55c47ab745b0be729116dc1cfdde~mv2.jpg/v1/crop/x_53,y_0,w_429,h_495/fill/w_500,h_600,al_c,q_85,usm_0.66_1.00_0.01,enc_avif,quality_auto/Billede%2012-06-2014%2000_10_edited.jpg" },
        { name: "Silke Kirstine Ekmann Kidholm", instrument: "Violin", imageUrl: "https://static.wixstatic.com/media/d3f0ae_a02aca9ac4a740b3b4436e939937fd78~mv2.jpg/v1/crop/x_766,y_339,w_1947,h_2381/fill/w_500,h_600,al_c,q_85,usm_0.66_1.00_0.01,enc_avif,quality_auto/Presse2022_MatiasBager4162%20(1).jpg" }
      ];
      
      const DEFAULT_COLLABORATORS = ["Signe Svendsen", "Brimheim", "Mads Langer", "Steffen Brandt", "Claus Hempler", "eee gee", "Peter Sommer", "Simon Kvamm", "Emma Sehested Høeg", "Father John Misty", "Jacob Bellens", "Nicklas Sahl", "Lucky Lo", "Fallulah", "Oh Land", "Jenny Wilson", "Puk Qvortrup", "Kira Skov", "Ginne Marker", "Asbjørn", "Teitur", "Ida Wenøe", "Teatret Møllen", "ROYA", "Hjalte Ross", "Søren Huss", "Mathilde Falch", "Mumle", "De Eneste To", "Hvalfugl", "Reveal Party", "Rikke Thomsen", "Hugo Helmig", "Sebastian Wolff", "Benjamin Hav", "Pernille Rosendahl", "Karen Troldborg", "Thomas Helmig", "Guldimund", "Jonas H. Petersen", "ELBA", "Rod Stewart", "Baloosh", "Lydmor", "Mattias Kolstrup", "Katinka", "Caroline Henderson", "Lowly", "Thomas Buttenschøn"];

      const DEFAULT_HOME_CONTENT = {
        tagline: "Det Danske Strygerensemble",
        title_lines: ["WHO", "KILLED", "BAMBI"],
        highlight_index: 2,
        highlight_class: 'text-wkbCoral',
        cta_label: "Oplev Koncerter"
      };

      const DEFAULT_ABOUT_CONTENT = {
        intro_title_main: "Klassisk elegance.",
        intro_title_emphasis: "Moderne vildskab.",
        intro_text: "Siden 2009 har vi udforsket grænserne for, hvad et strygerensemble kan være. Vi spiller ikke bare noderne; vi skaber fortællinger i spændingsfeltet mellem det akustiske og det elektriske."
      };

      const DEFAULT_PLUS_CONTENT = {
        header_title: "WKB+",
        header_subtitle: "Udvalgte Samarbejder",
        sections: [
          {
            id: 'mariam',
            label: "Who Killed Bambi +",
            title: "Mariam Wallentin",
            image_url: "https://static.wixstatic.com/media/d3f0ae_e4acfcc0442e47ccbd5595014470fabe~mv2.jpg/v1/fill/w_442,h_331,al_c,q_80,usm_0.66_1.00_0.01,enc_avif,quality_auto/Mariam%20Wallentin%20%26%20Who%20Killed%20Bambi_03%20(giesenbauer).jpg",
            image_credit: "Foto: Bjørn Giesenbauer",
            quote: "\"I Mariam Believer-sangen \"Invisible Giving\" har jeg svært ved at holde benene i ro, selvom der ingen slagtøj er på scenen. De fem strygere groover simpelthen for vildt, og de to celloer lyder næsten som en kontrabas.\"",
            quote_author: "Ole Rosenstadt Svidt, Gaffa",
            rating:5,
            layout: 'image-left'
          },
          {
            id: 'lucky',
            label: "Who Killed Bambi +",
            title: "Lucky Lo",
            video_url: "https://video.wixstatic.com/video/d3f0ae_b2e0dca052e34c59bc66b2b14aac99c0/360p/mp4/file.mp4",
            quote: "\"Foreningen af sangeren og strygerne var lige præcis så magisk, som man turde håbe på. Lyden var flydende, drømmende, legende og med et utroligt nærvær fra scenen.\"",
            quote_author: "Siff Haar-Lund, Gaffa",
            rating:5,
            layout: 'video-right'
          }
        ],
        info_title: "Hvad er Who Killed Bambi+?",
        info_paragraphs: [
          "Who Killed Bambi+ eller ganske kort WKB+ er en række af unikke koncerter, hvor alle elementer udføres af sangstemmer og strygere - nyfortolkninger udført af os i samspil med artisten selv.",
          "WKB+ har budt på samarbejder med en lang række interessante nordiske artister og anmelderroste optrædener på koncertsteder som Kulturmødet på Mors, Musikhuset Aarhus og Ofelia Plads (Det Kongelige Teater)."
        ],
        info_note: "I december2022 afholdte vi en enestående live koncertopførsel af albummet '12\" med alle albummets 12 solister, tre pigekor og lyskunst i Store Sal i Musikhuset Aarhus støttet af Kirsten og Gunnar Fonden."
      };

      const DEFAULT_FOOTER_CONTENT = {
        social_links: [
          { label: 'Instagram', url: '#' },
          { label: 'Facebook', url: '#' },
          { label: 'YouTube', url: '#' }
        ],
        copyright: "© 2025 WhoKilledBambi",
        credit: "By StageReadyWeb"
      };

      const mergePlusContent = (source) => {
        const safe = source || {};
        const merged = { ...DEFAULT_PLUS_CONTENT, ...safe };
        merged.sections = (Array.isArray(safe.sections) && safe.sections.length)
          ? safe.sections
          : DEFAULT_PLUS_CONTENT.sections;
        merged.info_paragraphs = (Array.isArray(safe.info_paragraphs) && safe.info_paragraphs.length)
          ? safe.info_paragraphs
          : DEFAULT_PLUS_CONTENT.info_paragraphs;
        return merged;
      };

      // --- COMPONENTS ---
      const SEOManager = ({ view, content }) => {
        useEffect(() => {
          const titles = {
            home: 'Who Killed Bambi | Forside',
            news: 'Nyheder | Who Killed Bambi',
            about: 'Ensemblet | Who Killed Bambi',
            plus: 'WKB+ Samarbejder | Who Killed Bambi',
            calendar: 'Koncerter & Booking | Who Killed Bambi'
          };
          
          const descriptions = {
            home: 'Who Killed Bambi er et moderne strygerensemble. Oplev koncerter, nyt musik og unikke samarbejder.',
            news: 'Læs de seneste nyheder fra Who Killed Bambi. Pressemeddelelser, udgivelser og koncertannonceringer.',
            about: 'Mød musikerne i Who Killed Bambi. Et dansk strygerensemble dedikeret til moderne klassisk musik.',
            plus: 'WKB+ er vores serie af unikke samarbejder med nogle af Nordens største artister.',
            calendar: 'Se kommende koncerter og book Who Killed Bambi til dit næste event eller festival.'
          };

          document.title = titles[view] || 'Who Killed Bambi';
          const metaDesc = document.querySelector('meta[name="description"]');
          if (metaDesc) metaDesc.setAttribute("content", descriptions[view]);
        }, [view]);

        return null;
      };

      const RichTextRenderer = ({ html }) => {
        if (!html) return null;
        return (
          <div 
            className="prose prose-lg max-w-none text-wkbInk/80 leading-relaxed"
            dangerouslySetInnerHTML={{ __html: html }}
          />
        );
      };

      const Spotlight = () => {
        const [position, setPosition] = useState({ x: 0, y: 0 });
        useEffect(() => {
          const handleMouseMove = (e) => {
            requestAnimationFrame(() => setPosition({ x: e.clientX, y: e.clientY }));
          };
          window.addEventListener('mousemove', handleMouseMove);
          return () => window.removeEventListener('mousemove', handleMouseMove);
        }, []);
        return (
          <div className="pointer-events-none fixed inset-0 z-30 transition-opacity duration-700"
            style={{
              background: `radial-gradient(800px circle at ${position.x}px ${position.y}px, rgba(255,255,255, 0.4), transparent 50%)` 
            }}
          />
        );
      };

      const AudioPlayer = () => {
        const [isOpen, setIsOpen] = useState(false);
        return (
          <div className="fixed bottom-6 right-6 z-50 flex flex-col items-end gap-4">
            <div className={`transition-all duration-500 ease-out overflow-hidden rounded-sm shadow-2xl ${isOpen ? 'max-h-[400px] opacity-100 translate-y-0' : 'max-h-0 opacity-0 translate-y-8'}`}>
              <iframe style={{borderRadius: '2px'}} src="https://open.spotify.com/embed/artist/1Bcrf69IwrdZdJAtu0VjqK?utm_source=generator&theme=0" width="300" height="80" frameBorder="0" allowFullScreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy" className="bg-wkbPaper"></iframe>
            </div>
            <div className="flex items-center gap-4">
              <div onClick={() => setIsOpen(!isOpen)} className={`cursor-pointer text-[10px] font-sans font-bold text-wkbInk tracking-[0.2em] uppercase transition-opacity duration-500 ${isOpen ? 'opacity-0' : 'opacity-60 hidden sm:block hover:opacity-100'}`}>Lyt</div>
              <button onClick={() => setIsOpen(!isOpen)} className={`w-12 h-12 rounded-full border border-wkbInk/10 flex items-center justify-center transition-all duration-300 backdrop-blur-md bg-wkbPaper/50 hover:bg-white shadow-lg ${isOpen ? 'border-wkbCoral text-wkbCoral' : 'text-wkbInk hover:text-wkbCoral'}`}>
                {isOpen ? <XIcon size={18} /> : <Music size={20} />}
              </button>
            </div>
          </div>
        );
      };

      const IntroSequence = ({ onComplete }) => {
        const [stage, setStage] = useState(0);

        useEffect(() => {
          const s1 = setTimeout(() => setStage(1), 500);
          const s2 = setTimeout(() => setStage(2), 2000);
          const s3 = setTimeout(() => setStage(3), 3500);
          const s4 = setTimeout(() => setStage(4), 5000);
          const s5 = setTimeout(() => setStage(5), 8000);
          const s6 = setTimeout(() => onComplete(), 9000); 
          return () => [s1, s2, s3, s4, s5, s6].forEach(clearTimeout);
        }, [onComplete]);

        const getPosition = (word) => {
          if (stage < 4) {
            if (word === 'WHO') return 'opacity-0 -translate-x-[150px] blur-md';
            if (word === 'KILLED') return 'opacity-0 translate-x-[150px] blur-md';
            if (word === 'BAMBI') return 'opacity-0 translate-y-[150px] blur-md';
          }
          if (stage >= 4) {
            if (word === 'WHO') return 'opacity-100 -translate-x-[5.5rem] sm:-translate-x-[12rem] -translate-y-[2.5rem] sm:-translate-y-[4rem] blur-0';
            if (word === 'KILLED') return 'opacity-100 translate-x-[6.5rem] sm:translate-x-[14rem] -translate-y-[2.5rem] sm:-translate-y-[4rem] blur-0';
            if (word === 'BAMBI') return 'opacity-100 translate-y-[2.5rem] sm:translate-y-[4rem] blur-0';
          }
        };

        return (
          <div className={`fixed inset-0 z-50 bg-wkbPaper flex flex-col items-center justify-center overflow-hidden transition-all duration-1000 ${stage === 5 ? 'opacity-0 pointer-events-none' : 'opacity-100'}`}>
            <div className="relative w-full max-w-6xl h-[80vh] flex items-center justify-center">
              <div className={`absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 rounded-full mix-blend-multiply transition-all duration-[2000ms] ease-in-out
                 ${stage === 0 ? 'w-0 h-0 opacity-0 bg-wkbInk blur-0' : ''}
                 ${stage === 1 ? 'w-32 h-32 opacity-100 bg-wkbInk blur-0' : ''}
                 ${stage === 2 ? 'w-64 h-64 opacity-90 bg-wkbCoral scale-110 blur-sm' : ''}
                 ${stage === 3 ? 'w-80 h-80 opacity-80 bg-wkbSage scale-125 blur-md' : ''}
                 ${stage >= 4 ? 'w-96 h-96 opacity-40 bg-wkbCoral animate-pulse-slow blur-3xl' : ''}
              `}></div>
               <div className={`absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 rounded-full mix-blend-multiply filter blur-3xl transition-all duration-[2500ms] ease-in-out delay-300
                 ${stage < 3 ? 'w-0 h-0 opacity-0' : 'w-[500px] h-[500px] opacity-20 bg-wkbSage'}
              `}></div>
              <h1 className={`absolute text-6xl sm:text-8xl md:text-9xl font-serif font-bold tracking-tighter text-wkbSage mix-blend-multiply transition-all duration-[1500ms] cubic-bezier(0.22, 1, 0.36, 1) ${getPosition('WHO')}`}>WHO</h1>
              <h1 className={`absolute text-6xl sm:text-8xl md:text-9xl font-serif font-bold tracking-tighter text-wkbCoral mix-blend-multiply transition-all duration-[1500ms] cubic-bezier(0.22, 1, 0.36, 1) delay-100 ${getPosition('KILLED')}`}>KILLED</h1>
              <h1 className={`absolute text-6xl sm:text-8xl md:text-9xl font-serif font-bold tracking-tighter text-wkbInk mix-blend-multiply transition-all duration-[1500ms] cubic-bezier(0.22, 1, 0.36, 1) delay-200 ${getPosition('BAMBI')}`}>BAMBI</h1>
            </div>
          </div>
        );
      };

      const Navigation = ({ currentView, setView, pages }) => {
        const [menuOpen, setMenuOpen] = useState(false);
        const navItems = [
          { id: 'home', label: 'Forside' },
          { id: 'news', label: 'Nyheder' },
          { id: 'about', label: 'Ensemblet' },
          { id: 'plus', label: 'WKB+' },
          { id: 'calendar', label: 'Kalender' },
        ];
        const allItems = [...navItems, ...((pages || []).filter(p => p.data?.show_in_nav).map(p => ({ id: p.slug, label: p.title || p.slug })))];

        return (
          <nav className="fixed top-0 w-full z-40 py-8 px-6 md:px-8 flex justify-between items-start pointer-events-none">
            <div className="pointer-events-auto cursor-pointer group" onClick={() => setView('home')}>
              <div className="font-serif text-2xl tracking-tighter font-bold text-wkbInk blend-ink">WhoKilledBambi</div>
              <div className="h-px w-0 group-hover:w-full bg-wkbInk transition-all duration-500"></div>
            </div>

            <ul className="pointer-events-auto hidden md:flex gap-8 items-center">
              {allItems.map(item => (
                <li key={item.id}>
                  <button onClick={() => setView(item.id)} className={`relative text-xs tracking-[0.24em] uppercase transition-all duration-500 ${currentView === item.id ? 'text-wkbInk font-bold' : 'text-wkbInk/60 hover:text-wkbInk'}`}>
                    {item.label}
                    <span className={`absolute -bottom-2 left-0 h-px bg-wkbInk transition-all duration-500 ${currentView === item.id ? 'w-full' : 'w-0 group-hover:w-full'}`}></span>
                  </button>
                </li>
              ))}
            </ul>

            <button
              className="pointer-events-auto md:hidden flex items-center gap-3 px-4 py-2 rounded-full border border-wkbInk/20 bg-wkbPaper/70 backdrop-blur-sm text-xs uppercase tracking-[0.3em] text-wkbInk"
              onClick={() => setMenuOpen(true)}
            >
              Menu
              <span className="inline-block w-4 h-4 relative">
                <span className="absolute left-0 top-0.5 w-4 h-px bg-wkbInk"></span>
                <span className="absolute left-0 top-2 w-4 h-px bg-wkbInk"></span>
                <span className="absolute left-0 top-3.5 w-4 h-px bg-wkbInk"></span>
              </span>
            </button>

            {menuOpen && (
              <div className="fixed inset-0 z-50 bg-wkbInk/70 backdrop-blur-md pointer-events-auto">
                <div className="absolute inset-x-0 top-0 p-6 flex items-center justify-between">
                  <div className="font-serif text-2xl tracking-tighter font-bold text-wkbPaper">WhoKilledBambi</div>
                  <button
                    className="px-4 py-2 rounded-full border border-wkbPaper/30 text-wkbPaper text-xs uppercase tracking-[0.3em]"
                    onClick={() => setMenuOpen(false)}
                  >
                    Luk
                  </button>
                </div>
                <div className="absolute inset-0 flex items-center justify-center px-8">
                  <ul className="w-full max-w-md space-y-6">
                    {allItems.map(item => (
                      <li key={item.id}>
                        <button
                          onClick={() => { setView(item.id); setMenuOpen(false); }}
                          className={`w-full text-left text-3xl font-serif tracking-tight transition-all duration-300 ${currentView === item.id ? 'text-wkbPaper' : 'text-wkbPaper/60 hover:text-wkbPaper'}`}
                        >
                          {item.label}
                        </button>
                      </li>
                    ))}
                  </ul>
                </div>
              </div>
            )}
          </nav>
        );
      };

      const Footer = ({ footerContent }) => (
        <footer className="pt-32 pb-16 px-6 md:px-12 border-t border-wkbInk/10">
          <div className="max-w-6xl mx-auto grid md:grid-cols-2 gap-12 mb-16">
            <div>
               <h4 className="text-xs font-bold uppercase tracking-widest text-wkbInk mb-6">Who Killed Bambi</h4>
               <ul className="space-y-2 text-sm text-wkbInk/60">
                 <li>Det Danske Strygerensemble</li>
                 <li>Kontakt: booking@whokilledbambi.dk</li>
                 <li>CVR: 12345678</li>
               </ul>
            </div>
            <div>
               <h4 className="text-xs font-bold uppercase tracking-widest text-wkbInk mb-6">Følg Med</h4>
               <div className="flex gap-4">
                 {(footerContent.social_links || []).map((link, idx) => (
                   <a key={idx} href={link.url || '#'} className="text-wkbInk/40 hover:text-wkbInk transition-colors">{link.label}</a>
                 ))}
               </div>
            </div>
          </div>
          <div className="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-end border-t border-wkbInk/10 pt-8 text-[10px] uppercase tracking-widest text-wkbInk/30">
            <span>{footerContent.copyright || '© 2025 WhoKilledBambi'}</span>
            <span>{footerContent.credit || 'Web by Skouboe'}</span>
          </div>
        </footer>
      );

      const TextBlock = ({ heading, body }) => (
        <section className="py-16 px-6 md:px-12 max-w-4xl mx-auto">
          {heading && <h3 className="text-3xl md:text-4xl font-serif text-wkbInk mb-6">{heading}</h3>}
          <div className="text-lg md:text-xl text-wkbInk/80 leading-relaxed">
            {body ? <RichTextRenderer html={body} /> : null}
          </div>
        </section>
      );

      const ImageBlock = ({ image_url, image_focus_x, image_focus_y, image_scale, caption }) => {
        const meta = parseImageMeta(image_url);
        const fx = image_focus_x ?? meta.fx;
        const fy = image_focus_y ?? meta.fy;
        const z = image_scale ?? meta.z;
        return (
          <section className="py-12 px-6 md:px-12 max-w-5xl mx-auto">
            <div className={`overflow-hidden rounded-sm bg-[#E0DCD5] ${aspectClass(image_aspect)}`}>
              <img
                src={meta.src}
                alt={caption || 'Billede'}
                className="w-full h-full object-cover"
                style={{
                  objectPosition: `${fx}% ${fy}%`,
                  transform: `scale(${z / 100})`,
                  transformOrigin: `${fx}% ${fy}%`
                }}
              />
            </div>
            {caption && <div className="text-xs uppercase tracking-widest text-wkbInk/50 mt-3">{caption}</div>}
          </section>
        );
      };

      const IntroBlock = ({ intro_title_main, intro_title_emphasis, intro_text }) => (
        <section className="py-20 px-6 md:px-12 max-w-4xl mx-auto">
          <h2 className="text-5xl md:text-6xl font-serif text-wkbInk mb-6">
            {intro_title_main} <span className="text-wkbCoral">{intro_title_emphasis}</span>
          </h2>
          <div className="text-lg md:text-xl text-wkbInk/80 leading-relaxed">
            {intro_text ? <RichTextRenderer html={intro_text} /> : null}
          </div>
        </section>
      );

      const MembersBlock = ({ members }) => (
        <section className="py-20 px-6 md:px-12 max-w-6xl mx-auto">
          <div className="flex justify-between items-end mb-12">
            <h3 className="text-sm font-bold uppercase tracking-widest text-wkbInk/40">Musikerne</h3>
          </div>
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-4 gap-y-12">
            {(members || []).map((member, idx) => (
              <div key={idx} className="group">
                <div className="aspect-[3/4] overflow-hidden mb-4 relative bg-[#E0DCD5]">
                  {(() => {
                    const meta = parseImageMeta(member.imageUrl);
                    return (
                      <img
                        src={meta.src}
                        alt={member.name}
                        className="w-full h-full object-cover grayscale group-hover:grayscale-0 transition-all duration-700 ease-in-out"
                        style={{
                          objectPosition: `${meta.fx}% ${meta.fy}%`,
                          transform: `scale(${meta.z / 100})`,
                          transformOrigin: `${meta.fx}% ${meta.fy}%`
                        }}
                      />
                    );
                  })()}
                  <div className="absolute inset-0 bg-wkbInk/10 opacity-0 group-hover:opacity-100 transition-opacity duration-500 mix-blend-multiply"></div>
                </div>
                <h4 className="text-2xl font-serif italic text-wkbInk blend-ink">{member.name}</h4>
                <p className="text-xs uppercase tracking-widest text-wkbSage mt-1">{member.instrument}</p>
              </div>
            ))}
          </div>
        </section>
      );

      const ContactBlock = ({ title = 'Kontakt' }) => (
        <section className="py-20 px-6 md:px-12 max-w-3xl mx-auto">
          <h3 className="text-4xl font-serif text-wkbInk mb-8">{title}</h3>
          <form className="space-y-4">
            <div>
              <label className="text-xs uppercase tracking-widest text-wkbInk/50 block mb-2">Navn</label>
              <input type="text" className="w-full bg-white border border-wkbInk/10 p-3 focus:border-wkbCoral outline-none" />
            </div>
            <div>
              <label className="text-xs uppercase tracking-widest text-wkbInk/50 block mb-2">Email</label>
              <input type="email" className="w-full bg-white border border-wkbInk/10 p-3 focus:border-wkbCoral outline-none" />
            </div>
            <div>
              <label className="text-xs uppercase tracking-widest text-wkbInk/50 block mb-2">Besked</label>
              <textarea rows="4" className="w-full bg-white border border-wkbInk/10 p-3 focus:border-wkbCoral outline-none"></textarea>
            </div>
            <button type="button" className="w-full bg-wkbInk text-white py-3 uppercase tracking-widest font-bold hover:bg-wkbCoral transition-colors">Send Besked</button>
          </form>
        </section>
      );



      const EditorialBlock = ({ heading, body, align = 'left' }) => (
        <section className={`py-16 px-6 md:px-12 max-w-4xl mx-auto ${align === 'center' ? 'text-center' : 'text-left'}`}>
          {heading && <h3 className="text-3xl md:text-4xl font-serif text-wkbInk mb-6">{heading}</h3>}
          <div className="text-lg md:text-xl text-wkbInk/80 leading-relaxed">
            {body ? <RichTextRenderer html={body} /> : null}
          </div>
        </section>
      );

      const MediaTextBlock = ({ title, body, media_url, media_aspect, credit, layout = 'image-left', stack = 'image-first', isVideo = false }) => {
        const hasText = Boolean((title && title.trim()) || (body && body.trim()));
        if (!hasText) {
          return (
            <section className="py-12 px-6 md:px-12 max-w-6xl mx-auto">
              <div className={`overflow-hidden rounded-sm bg-[#E0DCD5] ${aspectClass(media_aspect)}`}>
                {isVideo ? (
                  <video src={media_url} controls className="w-full h-full object-cover" />
                ) : (
                  <img src={media_url} alt={title || ''} className="w-full h-full object-cover" />
                )}
              </div>
              {credit && <div className="text-xs uppercase tracking-widest text-wkbInk/50 mt-3">{credit}</div>}
            </section>
          );
        }

        const textOrder = stack === 'text-first' ? 'order-1' : 'order-2';
        const mediaOrder = stack === 'text-first' ? 'order-2' : 'order-1';
        const mdTextOrder = layout === 'image-right' ? 'md:order-2' : 'md:order-1';
        const mdMediaOrder = layout === 'image-right' ? 'md:order-1' : 'md:order-2';
        return (
          <section className="py-20 px-6 md:px-12 max-w-6xl mx-auto">
            <div className="grid md:grid-cols-2 gap-10 items-center">
              <div className={`${textOrder} ${mdTextOrder}`}>
                <h3 className="text-4xl md:text-5xl font-serif text-wkbInk mb-6">{title}</h3>
                <div className="text-lg md:text-xl text-wkbInk/80 leading-relaxed">{body ? <RichTextRenderer html={body} /> : null}</div>
              </div>
              <div className={`${mediaOrder} ${mdMediaOrder}`}>
                <div className={`overflow-hidden rounded-sm bg-[#E0DCD5] ${aspectClass(media_aspect)}`}>
                  {isVideo ? (
                    <video src={media_url} controls className="w-full h-full object-cover" />
                  ) : (
                    <img src={media_url} alt={title} className="w-full h-full object-cover" />
                  )}
                </div>
                {credit && <div className="text-xs uppercase tracking-widest text-wkbInk/50 mt-3">{credit}</div>}
              </div>
            </div>
          </section>
        );
      };

      const QuoteBlock = ({ quote, author, rating }) => (
        <section className="py-20 px-6 md:px-12 max-w-4xl mx-auto">
          <blockquote className="text-2xl md:text-3xl font-serif italic text-wkbInk/90 leading-relaxed mb-6">{quote}</blockquote>
          <div className="flex items-center gap-4">
            <div className="text-xs font-bold uppercase tracking-widest text-wkbInk/60">{author}</div>
            {rating ? <div className="text-wkbCoral tracking-widest text-lg">{'★'.repeat(rating)}</div> : null}
          </div>
        </section>
      );

      const GridBlock = ({ title, cards, c1_title, c1_body, c2_title, c2_body, c3_title, c3_body }) => {
        const fallback = [
          { title: c1_title, body: c1_body },
          { title: c2_title, body: c2_body },
          { title: c3_title, body: c3_body }
        ].filter(c => c.title || c.body);
        const items = (Array.isArray(cards) && cards.length) ? cards : (fallback.length ? fallback : []);
        if (!items.length) return null;
        const cols = items.length >= 3 ? 'md:grid-cols-3' : (items.length === 2 ? 'md:grid-cols-2' : 'md:grid-cols-1');
        return (
          <section className="py-20 px-6 md:px-12 max-w-6xl mx-auto">
            {title && <h3 className="text-4xl font-serif text-wkbInk mb-10">{title}</h3>}
            <div className={`grid ${cols} gap-8`}>
              {items.map((c, i) => (
                <div key={i} className="border border-wkbInk/10 bg-white/40 p-6 rounded-sm">
                  {c.title && <div className="text-xl font-serif text-wkbInk mb-3">{c.title}</div>}
                  {c.body && <div className="text-sm text-wkbInk/70 leading-relaxed">{c.body}</div>}
                </div>
              ))}
            </div>
          </section>
        );
      };

      const GalleryBlock = ({ title, g1_url, g1_credit, g2_url, g2_credit, g3_url, g3_credit }) => (
        <section className="py-20 px-6 md:px-12 max-w-6xl mx-auto">
          {title && <h3 className="text-4xl font-serif text-wkbInk mb-10">{title}</h3>}
          <div className="grid md:grid-cols-3 gap-6">
            {[{u:g1_url,c:g1_credit},{u:g2_url,c:g2_credit},{u:g3_url,c:g3_credit}].map((g, i) => (
              <div key={i}>
                <div className="overflow-hidden rounded-sm bg-[#E0DCD5] aspect-[4/3]">
                  {g.u && <img src={g.u} className="w-full h-full object-cover" />}
                </div>
                {g.c && <div className="text-xs uppercase tracking-widest text-wkbInk/50 mt-3">{g.c}</div>}
              </div>
            ))}
          </div>
        </section>
      );

      const CtaBlock = ({ title, body, button_label, button_url }) => (
        <section className="py-20 px-6 md:px-12 max-w-4xl mx-auto text-center">
          {title && <h3 className="text-4xl font-serif text-wkbInk mb-6">{title}</h3>}
          <div className="text-lg md:text-xl text-wkbInk/80 leading-relaxed mb-8">{body ? <RichTextRenderer html={body} /> : null}</div>
          {button_label && <a href={button_url || '#'} className="inline-flex items-center gap-3 px-8 py-3 border border-wkbInk/20 rounded-full hover:border-wkbInk transition-all duration-500 bg-wkbPaper/50 backdrop-blur-sm">
            <span className="text-xs uppercase tracking-widest">{button_label}</span>
          </a>}
        </section>
      );

      const HeroBlock = ({ tagline, title_lines, highlight_index, highlight_class, cta_label, cta_url, background_type = 'none', background_url = '' }) => (
        <section className="min-h-[70vh] flex flex-col items-center justify-center text-center px-6 py-20 relative overflow-hidden bg-[#E5E2DB]">
          {background_type === 'video' && background_url ? (
            <div className="absolute inset-0 -z-10">
              <video autoPlay loop muted playsInline className="w-full h-full object-cover">
                <source src={background_url} type="video/mp4" />
              </video>
              <div className="absolute inset-0 bg-wkbPaper/40 mix-blend-multiply"></div>
            </div>
          ) : null}
          {background_type === 'image' && background_url ? (
            <div className="absolute inset-0 -z-10">
              <img src={background_url} className="w-full h-full object-cover" />
              <div className="absolute inset-0 bg-wkbPaper/40 mix-blend-multiply"></div>
            </div>
          ) : null}
          <div className="absolute -top-10 -left-10 w-72 h-72 rounded-full bg-wkbCoral/20 blur-3xl"></div>
          <div className="absolute -bottom-10 -right-10 w-80 h-80 rounded-full bg-wkbSage/30 blur-3xl"></div>
          <div className="relative z-10 flex flex-col items-center">
            <div className="mb-6">
              <span className="text-[10px] tracking-[0.4em] uppercase text-wkbInk/50 font-bold">{tagline || 'Det Danske Strygerensemble'}</span>
            </div>
            <h1 className="text-[14vw] md:text-[9vw] leading-[0.85] font-serif text-wkbInk blend-ink text-editorial mb-10">
              {(title_lines || ['WHO', 'KILLED', 'BAMBI']).map((line, idx) => {
                const highlightIndex = highlight_index ?? 2;
                const isHighlight = idx === highlightIndex;
                const highlightClass = highlight_class || 'text-wkbCoral';
                return (
                  <React.Fragment key={idx}>
                    {isHighlight ? <span className={highlightClass}>{line}</span> : line}
                    {idx < (title_lines || []).length - 1 && <br/>}
                  </React.Fragment>
                );
              })}
            </h1>
            {cta_label && (
              <div className="flex justify-center w-full">
                <a href={resolveCtaLink(cta_url)} className="group px-8 py-3 border border-wkbInk/20 rounded-full hover:border-wkbInk transition-all duration-500 flex items-center gap-3 bg-wkbPaper/50 backdrop-blur-sm">
                  <span className="text-xs uppercase tracking-widest group-hover:mr-2 transition-all">{cta_label}</span>
                  <ArrowRight size={16} className="opacity-0 -ml-4 group-hover:opacity-100 group-hover:ml-0 transition-all duration-300" />
                </a>
              </div>
            )}
          </div>
        </section>
      );

      const BuilderPage = ({ page, members, plusContent }) => {
        const blocks = page?.data?.blocks || [];
        return (
          <div className="min-h-screen">
            {blocks.map((block, idx) => {
              const type = block.type;
              if (type === 'hero') {
                return <HeroBlock key={idx} tagline={block.tagline} title_lines={block.title_lines} highlight_index={block.highlight_index} highlight_class={block.highlight_class} cta_label={block.cta_label} cta_url={block.cta_url} background_type={block.background_type} background_url={block.background_url} />;
              }
              if (type === 'editorial') return <EditorialBlock key={idx} heading={block.heading} body={block.body} align={block.align} />;
              if (type === 'image_text') return <MediaTextBlock key={idx} title={block.title} body={block.body} media_url={block.media_url} media_aspect={block.media_aspect} credit={block.credit} layout={block.layout} stack={block.stack} />;
              if (type === 'video_text') return <MediaTextBlock key={idx} title={block.title} body={block.body} media_url={block.media_url} media_aspect={block.media_aspect} credit={block.credit} layout={block.layout} stack={block.stack} isVideo />;
              if (type === 'quote') return <QuoteBlock key={idx} quote={block.quote} author={block.author} rating={block.rating} />;
              if (type === 'grid') return <GridBlock key={idx} title={block.title} cards={block.cards} c1_title={block.c1_title} c1_body={block.c1_body} c2_title={block.c2_title} c2_body={block.c2_body} c3_title={block.c3_title} c3_body={block.c3_body} />;
              if (type === 'gallery') return <GalleryBlock key={idx} title={block.title} g1_url={block.g1_url} g1_credit={block.g1_credit} g2_url={block.g2_url} g2_credit={block.g2_credit} g3_url={block.g3_url} g3_credit={block.g3_credit} />;
              if (type === 'cta') return <CtaBlock key={idx} title={block.title} body={block.body} button_label={block.button_label} button_url={block.button_url} />;
              return null;
            })}
          </div>
        );
      };

            const HomeSection = ({ setView, homeContent, collaborators }) => {
        return (
          <div className="min-h-screen flex flex-col relative overflow-hidden">
            <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 rounded-full mix-blend-multiply w-96 h-96 opacity-30 bg-wkbCoral animate-pulse-slow blur-3xl z-0 pointer-events-none"></div>
            <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 rounded-full mix-blend-multiply w-[500px] h-[500px] opacity-1 bg-wkbSage blur-3xl z-0 pointer-events-none delay-1000"></div>
            
            <div className="flex-grow flex flex-col items-center justify-center text-center px-4 pt-20 relative z-10">
               <div className="absolute inset-0 -z-20 opacity-30 grayscale mix-blend-multiply">
                  <video autoPlay loop muted playsInline className="w-full h-full object-cover">
                    <source src="wkbvid.mp4" type="video/mp4" />
                  </video>
               </div>

               <div className="mb-8 fade-in-up">
                 <span className="text-[10px] tracking-[0.4em] uppercase text-wkbInk/50 font-bold">{homeContent.tagline || 'Det Danske Strygerensemble'}</span>
               </div>

               <h1 className="text-[14vw] leading-[0.8] font-serif text-wkbInk blend-ink text-editorial mb-12 fade-in-up" style={{animationDelay: '0.1s'}}>
                 {(homeContent.title_lines || ['WHO', 'KILLED', 'BAMBI']).map((line, idx) => {
                   const highlightIndex = homeContent.highlight_index ?? 2;
                   const isHighlight = idx === highlightIndex;
                   const highlightClass = homeContent.highlight_class || 'text-wkbCoral';
                   return (
                     <React.Fragment key={idx}>
                       {isHighlight ? <span className={highlightClass}>{line}</span> : line}
                       {idx < (homeContent.title_lines || []).length - 1 && <br/>}
                     </React.Fragment>
                   );
                 })}
               </h1>
               
               <div className="fade-in-up" style={{animationDelay: '0.3s'}}>
                 <button onClick={() => setView('calendar')} className="group px-8 py-3 border border-wkbInk/20 rounded-full hover:border-wkbInk transition-all duration-500 flex items-center gap-3 bg-wkbPaper/50 backdrop-blur-sm">
                   <span className="text-xs uppercase tracking-widest group-hover:mr-2 transition-all">{homeContent.cta_label || 'Oplev Koncerter'}</span>
                   <ArrowRight size={16} className="opacity-0 -ml-4 group-hover:opacity-100 group-hover:ml-0 transition-all duration-300" />
                 </button>
               </div>
            </div>

            <div className="w-full bg-wkbInk text-wkbPaper py-4 overflow-hidden whitespace-nowrap relative z-20">
              <div className="inline-flex animate-marquee">
                {[...(collaborators || []), ...(collaborators || [])].map((name, i) => (
                  <span key={i} className="mx-8 text-sm uppercase tracking-widest font-bold opacity-80">{name} + </span>
                ))}
              </div>
            </div>
          </div>
        );
      };

      const NewsSection = ({ limit } = {}) => {
        const [news, setNews] = useState([]);
        const [loading, setLoading] = useState(true);

        useEffect(() => {
          if (previewMode === 'news' && previewPayload?.type === 'news') {
            const item = previewPayload.data || {};
            setNews([{
              title: item.title,
              publishedAt: item.publishedAt,
              body: item.body,
              imageUrl: item.imageUrl
            }]);
            setLoading(false);
            return;
          }

          supabaseClient
            .from('news')
            .select('*')
            .order('published_at', { ascending: false })
            .then(({ data, error }) => {
              if (error) throw error;
              const mapped = (data || []).map((item) => ({
                title: item.title,
                publishedAt: item.published_at,
                body: item.body,
                imageUrl: item.image_url
              }));
              setNews(limit ? mapped.slice(0, limit) : mapped);
              setLoading(false);
            })
            .catch(() => setLoading(false));
        }, []);

        const formatDate = (dateString) => {
          if (!dateString) return "";
          const date = new Date(dateString);
          return date.toLocaleDateString('da-DK', { day: '2-digit', month: '2-digit', year: 'numeric' }).replace(/\./g, '.');
        };

        if (loading) return <div className="flex justify-center items-center h-screen text-wkbInk"><Loader size={40} className="text-wkbCoral"/></div>;

        return (
          <div className="min-h-screen pt-32 px-6 md:px-12 max-w-6xl mx-auto fade-in-up pb-24">
             <header className="mb-24 text-center">
                <h2 className="text-6xl md:text-9xl font-serif text-wkbInk blend-ink mb-4">Nyheder</h2>
                <div className="w-px h-24 bg-wkbInk mx-auto mb-4 opacity-20"></div>
             </header>

             {news.length === 0 && (
               <div className="text-center py-20">
                 <p className="font-serif text-2xl italic text-wkbInk/50">Der er ingen nyheder endnu.</p>
               </div>
             )}

             <div className="grid gap-20">
               {news.map((item, idx) => (
                 <article key={idx} className="group grid md:grid-cols-12 gap-8 border-b border-wkbInk/10 pb-20 relative">
                    <div className="md:col-span-3 md:sticky md:top-32 self-start">
                       <div className="pl-0 md:pl-6 md:border-l-2 border-wkbCoral/50 py-2">
                          <span className="block text-xs font-bold uppercase tracking-widest text-wkbInk/40 mb-2">Publiceret</span>
                          <span className="block text-4xl lg:text-5xl font-serif italic text-wkbCoral blend-ink leading-none">
                            {formatDate(item.publishedAt)}
                          </span>
                       </div>
                    </div>
                    
                    <div className="md:col-span-9">
                       {item.imageUrl && (() => {
                         const meta = parseImageMeta(item.imageUrl);
                         return (
                           <div className="mb-8 overflow-hidden rounded-sm aspect-video md:aspect-[21/9]">
                             <img 
                               src={meta.src} 
                               alt={item.title} 
                               className="w-full h-full object-cover grayscale group-hover:grayscale-0 transition-all duration-700" 
                               style={{
                                 objectPosition: `${meta.fx}% ${meta.fy}%`,
                                 transform: `scale(${meta.z / 100})`,
                                 transformOrigin: `${meta.fx}% ${meta.fy}%`
                               }}
                             />
                           </div>
                         );
                       })()}
                       <h3 className="text-4xl md:text-5xl font-serif text-wkbInk mb-6 group-hover:text-wkbCoral transition-colors duration-300">{item.title}</h3>
                       <div className="text-lg md:text-xl text-wkbInk/80 leading-relaxed max-w-3xl">
                         {item.body ? <RichTextRenderer html={item.body} /> : null}
                       </div>
                    </div>
                 </article>
               ))}
             </div>
          </div>
        );
      };

      const AboutSection = ({ aboutContent, members }) => {
         const [showContact, setShowContact] = useState(false);
         const [contactSent, setContactSent] = useState(false);

         const handleContactSubmit = (e) => {
           e.preventDefault();
           setContactSent(true);
           setTimeout(() => { setShowContact(false); setContactSent(false); }, 2000);
         }

        return (
        <div className="min-h-screen pt-32 px-6 md:px-12 max-w-[1400px] mx-auto fade-in-up">
           <div className="grid md:grid-cols-12 gap-12 mb-40 border-b border-wkbInk/10 pb-20">
             <div className="md:col-span-8">
               <h2 className="text-5xl md:text-7xl lg:text-8xl font-serif text-wkbInk leading-[0.9] blend-ink text-editorial mb-8">
                 {aboutContent.intro_title_main || 'Klassisk elegance.'}<br/>
                 <span className="text-wkbSage italic">{aboutContent.intro_title_emphasis || 'Moderne vildskab.'}</span>
               </h2>
             </div>
             <div className="md:col-span-4 flex flex-col justify-end pb-4">
               <p className="text-lg md:text-xl font-serif italic text-wkbInk/70 leading-relaxed">
                 {aboutContent.intro_text || 'Siden 2009 har vi udforsket grænserne for, hvad et strygerensemble kan være.'}
               </p>
               <button onClick={() => setShowContact(true)} className="mt-8 px-6 py-3 border border-wkbInk rounded-full text-xs uppercase tracking-widest hover:bg-wkbInk hover:text-white transition-colors w-full md:w-auto flex items-center justify-center gap-2">
                 <Envelope size={16}/> Kontakt / Booking
               </button>
             </div>
           </div>

           <div className="mb-20 p-8 border border-wkbInk/10 rounded-sm bg-white/30 backdrop-blur-sm">
             <h3 className="text-sm font-bold uppercase tracking-widest text-wkbInk/40 mb-6">Presse & Booking Tools</h3>
             <div className="grid md:grid-cols-3 gap-6">
                <a href="#" className="flex items-center gap-4 p-4 border border-wkbInk/5 hover:border-wkbCoral hover:bg-white/50 transition-all rounded-sm group">
                   <div className="w-10 h-10 bg-wkbPaper rounded-full flex items-center justify-center text-wkbCoral group-hover:scale-110 transition-transform">
                     <Download size={20}/>
                   </div>
                   <div>
                     <div className="font-serif font-bold text-wkbInk">EPK (PDF)</div>
                     <div className="text-[10px] text-wkbInk/50 uppercase">Høj opløsning</div>
                   </div>
                </a>
                <a href="#" className="flex items-center gap-4 p-4 border border-wkbInk/5 hover:border-wkbCoral hover:bg-white/50 transition-all rounded-sm group">
                   <div className="w-10 h-10 bg-wkbPaper rounded-full flex items-center justify-center text-wkbSage group-hover:scale-110 transition-transform">
                     <i className="ph-bold ph-images"></i>
                   </div>
                   <div>
                     <div className="font-serif font-bold text-wkbInk">Pressefotos</div>
                     <div className="text-[10px] text-wkbInk/50 uppercase">ZIP Download</div>
                   </div>
                </a>
                <a href="#" className="flex items-center gap-4 p-4 border border-wkbInk/5 hover:border-wkbCoral hover:bg-white/50 transition-all rounded-sm group">
                   <div className="w-10 h-10 bg-wkbPaper rounded-full flex items-center justify-center text-wkbInk group-hover:scale-110 transition-transform">
                     <i className="ph-bold ph-file-text"></i>
                   </div>
                   <div>
                     <div className="font-serif font-bold text-wkbInk">Tekst & Bio</div>
                     <div className="text-[10px] text-wkbInk/50 uppercase">Danish / English</div>
                   </div>
                </a>
             </div>
           </div>

           <div className="mb-20">
             <div className="flex justify-between items-end mb-12">
               <h3 className="text-sm font-bold uppercase tracking-widest text-wkbInk/40">Musikerne</h3>
             </div>
             <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-4 gap-y-12">
               {(members || []).map((member, idx) => (
                 <div key={idx} className="group cursor-none">
                   <div className="aspect-[3/4] overflow-hidden mb-4 relative bg-[#E0DCD5]">
                     {(() => {
                       const meta = parseImageMeta(member.imageUrl);
                       return (
                         <img 
                           src={meta.src} 
                           alt={member.name} 
                           className="w-full h-full object-cover grayscale group-hover:grayscale-0 transition-all duration-700 ease-in-out" 
                           style={{
                             objectPosition: `${meta.fx}% ${meta.fy}%`,
                             transform: `scale(${meta.z / 100})`,
                             transformOrigin: `${meta.fx}% ${meta.fy}%`
                           }}
                         />
                       );
                     })()}
                     <div className="absolute inset-0 bg-wkbInk/10 opacity-0 group-hover:opacity-100 transition-opacity duration-500 mix-blend-multiply"></div>
                   </div>
                   <h4 className="text-2xl font-serif italic text-wkbInk blend-ink">{member.name}</h4>
                   <p className="text-xs uppercase tracking-widest text-wkbSage mt-1">{member.instrument}</p>
                 </div>
               ))}
             </div>
           </div>

           {showContact && (
             <div className="fixed inset-0 z-50 bg-wkbInk/90 backdrop-blur-md flex items-center justify-center p-4">
               <div className="bg-wkbPaper max-w-lg w-full p-8 rounded-sm shadow-2xl relative animate-in fade-in zoom-in duration-300">
                  <button onClick={() => setShowContact(false)} className="absolute top-4 right-4 text-wkbInk/50 hover:text-wkbCoral"><XIcon size={24}/></button>
                  <h2 className="text-3xl font-serif text-wkbInk mb-6">Kontakt</h2>
                  
                  {contactSent ? (
                    <div className="text-center py-12">
                       <div className="text-4xl text-wkbSage mb-4"><i className="ph-fill ph-check-circle"></i></div>
                       <p className="text-lg font-serif italic text-wkbInk">Tak! Vi vender tilbage hurtigst muligt.</p>
                    </div>
                  ) : (
                    <form onSubmit={handleContactSubmit} className="space-y-4">
                      <div>
                        <label className="text-xs uppercase tracking-widest text-wkbInk/50 block mb-2">Navn</label>
                        <input type="text" required className="w-full bg-white border border-wkbInk/10 p-3 focus:border-wkbCoral outline-none" />
                      </div>
                      <div>
                        <label className="text-xs uppercase tracking-widest text-wkbInk/50 block mb-2">Email</label>
                        <input type="email" required className="w-full bg-white border border-wkbInk/10 p-3 focus:border-wkbCoral outline-none" />
                      </div>
                      <div>
                        <label className="text-xs uppercase tracking-widest text-wkbInk/50 block mb-2">Emne</label>
                        <select className="w-full bg-white border border-wkbInk/10 p-3 focus:border-wkbCoral outline-none">
                          <option>Booking</option>
                          <option>Presse</option>
                          <option>Andet</option>
                        </select>
                      </div>
                      <div>
                        <label className="text-xs uppercase tracking-widest text-wkbInk/50 block mb-2">Besked</label>
                        <textarea required rows="4" className="w-full bg-white border border-wkbInk/10 p-3 focus:border-wkbCoral outline-none"></textarea>
                      </div>
                      <button type="submit" className="w-full bg-wkbInk text-white py-3 uppercase tracking-widest font-bold hover:bg-wkbCoral transition-colors">Send Besked</button>
                    </form>
                  )}
               </div>
             </div>
           )}
        </div>
      );
      };
      
      const PlusSection = ({ plusContent }) => {
        const videoRef = useRef(null);
        const [isMuted, setIsMuted] = useState(true);

        const toggleMute = () => {
           if (videoRef.current) {
             videoRef.current.muted = !videoRef.current.muted;
             setIsMuted(!isMuted);
           }
        };

        const sections = plusContent.sections || [];

        return (
          <div className="min-h-screen pt-32 px-6 md:px-12 max-w-6xl mx-auto fade-in-up pb-24">
             <header className="mb-24 text-center">
                <h2 className="text-6xl md:text-9xl font-serif text-wkbInk blend-ink mb-4">
                  {plusContent.header_title || 'WKB+'}
                </h2>
                <p className="text-sm uppercase tracking-widest text-wkbInk/50">{plusContent.header_subtitle || 'Udvalgte Samarbejder'}</p>
             </header>

             {sections.map((section, idx) => {
               const isImageLeft = section.layout === 'image-left';
               const isVideo = !!section.video_url;
               const mediaBlock = (
                 <div className="order-2 group relative rounded-sm overflow-hidden shadow-2xl">
                   {isVideo ? (
                     <>
                       <video
                         ref={videoRef}
                         src={section.video_url}
                         autoPlay
                         loop
                         muted
                         playsInline
                         className="w-full aspect-video object-cover"
                       />
                       <button
                          onClick={toggleMute}
                          className="absolute bottom-4 right-4 w-10 h-10 bg-wkbPaper/80 backdrop-blur-md rounded-full flex items-center justify-center text-wkbInk hover:text-wkbCoral transition-colors"
                       >
                          {isMuted ? <SpeakerOff size={16} /> : <Speaker size={16} />}
                       </button>
                     </>
                   ) : (
                     <div className={`relative overflow-hidden rounded-sm ${aspectClass(section.image_aspect)}`}>
                        <img
                          src={section.image_url}
                          alt={section.title}
                          className="w-full h-full object-cover grayscale hover:grayscale-0 transition-all duration-700"
                          style={{
                            objectPosition: `${section.image_focus_x ?? 50}% ${section.image_focus_y ?? 50}%`,
                            transform: `scale(${(section.image_scale ?? 100) / 100})`,
                            transformOrigin: `${section.image_focus_x ?? 50}% ${section.image_focus_y ?? 50}%`
                          }}
                        />
                        {section.image_credit && (
                          <div className="absolute bottom-2 left-4 text-[10px] text-white/70 uppercase tracking-wider">{section.image_credit}</div>
                        )}
                     </div>
                   )}
                 </div>
               );

               const textBlock = (
                 <div className="order-1">
                   <div className="mb-2 text-xs font-bold uppercase tracking-widest text-wkbCoral">{section.label || 'Who Killed Bambi +'}</div>
                   <h3 className="text-4xl md:text-5xl font-serif italic text-wkbInk mb-8">{section.title}</h3>
                   <blockquote className="text-lg md:text-xl font-serif text-wkbInk/80 leading-relaxed mb-8 border-l-2 border-wkbSage/30 pl-6">
                     {section.quote}
                   </blockquote>
                   <div className="flex items-center gap-4">
                      <div className="text-xs font-bold uppercase tracking-widest text-wkbInk">{section.quote_author}</div>
                      {section.rating && (
                        <div className="text-wkbCoral tracking-widest text-lg">{'★'.repeat(section.rating)}</div>
                      )}
                   </div>
                 </div>
               );

               return (
                 <div key={section.id || idx} className={`grid md:grid-cols-2 gap-12 lg:gap-20 items-center mb-32 ${idx > 0 ? 'border-t border-wkbInk/10 pt-20' : ''}`}>
                   {isImageLeft ? (
                     <>
                       <div className="order-2 md:order-1">{mediaBlock}</div>
                       <div className="order-1 md:order-2">{textBlock}</div>
                     </>
                   ) : (
                     <>
                       <div className="order-1">{textBlock}</div>
                       <div className="order-2">{mediaBlock}</div>
                     </>
                   )}
                 </div>
               );
             })}

             <div className="max-w-3xl mx-auto bg-white/40 backdrop-blur-sm p-8 md:p-12 rounded-sm border border-wkbInk/5">
                <h3 className="text-3xl font-serif text-wkbInk mb-6">{plusContent.info_title || 'Hvad er Who Killed Bambi+?'}</h3>
                <div className="space-y-6 text-wkbInk/80 font-serif text-lg leading-relaxed">
                  {(plusContent.info_paragraphs || []).map((paragraph, i) => (
                    <p key={i}>{paragraph}</p>
                  ))}
                  {plusContent.info_note && (
                    <p className="italic text-sm text-wkbSage">{plusContent.info_note}</p>
                  )}
                </div>
             </div>

          </div>
        );
      };

            const CalendarSection = () => {
        const [events, setEvents] = useState([]);
        const [loading, setLoading] = useState(true);

        useEffect(() => {
          if (previewMode === 'calendar' && previewPayload?.type === 'events') {
            const item = previewPayload.data || {};
            setEvents([{
              title: item.title,
              subtitle: item.subtitle,
              date: item.date,
              location: item.location,
              ticketLink: item.ticketLink,
              theme: item.theme
            }]);
            setLoading(false);
            return;
          }

          supabaseClient
            .from('events')
            .select('*')
            .order('event_date', { ascending: true })
            .then(({ data, error }) => {
              if (error) throw error;
              const mapped = (data || []).map((item) => ({
                title: item.title,
                subtitle: item.subtitle,
                date: item.event_date,
                location: item.location,
                ticketLink: item.ticket_link,
                theme: item.theme
              }));
              setEvents(mapped);
              setLoading(false);
            })
            .catch(err => {
              console.error(err);
              setLoading(false);
            });
        }, []);

        const formatDayMonth = (dateString) => {
          if (!dateString) return "??.??";
          const date = new Date(dateString);
          return date.toLocaleDateString('da-DK', { day: '2-digit', month: '2-digit' }).replace(/\./g, '.');
        };

        const formatYear = (dateString) => {
           if (!dateString) return "";
           return new Date(dateString).getFullYear();
        };

        if (loading) return <div className="flex justify-center items-center h-screen text-wkbInk"><Loader size={40} className="text-wkbSage"/></div>;

        const now = new Date();
        const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const upcomingEvents = events.filter(e => e.date && new Date(e.date) >= todayStart);
        const pastEvents = events.filter(e => e.date && new Date(e.date) < todayStart);

        return (
          <div className="min-h-screen pt-32 px-4 max-w-6xl mx-auto fade-in-up pb-20">
            <header className="mb-24 text-center">
              <h2 className="text-6xl md:text-9xl font-serif text-wkbInk blend-ink mb-4">Koncerter</h2>
              <div className="w-px h-24 bg-wkbInk mx-auto mb-4 opacity-20"></div>
            </header>
            
            <div>
              {upcomingEvents.length === 0 && (
                 <div className="text-center py-16">
                     <p className="font-serif text-2xl italic text-wkbInk/50">Ingen kommende koncerter.</p>
                  </div>
                )}

              {upcomingEvents.length > 0 && (
                <>
                  <div className="text-xs font-bold uppercase tracking-widest text-wkbInk/40 mb-4">Kommende koncerter</div>
                  {upcomingEvents.map((event, idx) => (
                    <a href={event.ticketLink || '#'} key={`up-${idx}`} className="group block border-t border-wkbInk/10 hover:border-wkbInk transition-colors duration-500">
                      <div className="py-12 flex flex-col md:flex-row md:items-baseline gap-8 px-4 hover:bg-white/30 transition-colors duration-500">
                        <div className="w-32 shrink-0">
                          <span className={`text-5xl font-serif italic ${event.theme || 'text-wkbInk'} blend-ink block`}>
                            {formatDayMonth(event.date)}
                          </span>
                          <span className="text-xs font-bold text-wkbInk/30 block mt-2">{formatYear(event.date)}</span>
                        </div>
                        <div className="grow">
                          <h3 className="text-3xl md:text-5xl font-serif text-wkbInk mb-2 group-hover:translate-x-4 transition-transform duration-500 ease-out">{event.title}</h3>
                          <p className="text-sm uppercase tracking-widest text-wkbInk/50 group-hover:translate-x-4 transition-transform duration-500 delay-75">{event.subtitle}</p>
                        </div>
                        <div className="w-48 text-right shrink-0">
                          <span className="text-lg font-serif italic text-wkbInk/60 block mb-2">{event.location}</span>
                          <span className="text-[10px] uppercase tracking-widest font-bold text-wkbInk opacity-0 group-hover:opacity-100 transition-opacity duration-300">Køb Billet →</span>
                        </div>
                      </div>
                    </a>
                  ))}
                  <div className="border-t border-wkbInk/10"></div>
                </>
              )}

              {pastEvents.length > 0 && (
                <>
                  <div className="text-xs font-bold uppercase tracking-widest text-wkbInk/40 mt-16 mb-4">Tidligere koncerter</div>
                  {pastEvents.map((event, idx) => (
                    <div key={`past-${idx}`} className="group block border-t border-wkbInk/10">
                      <div className="py-10 flex flex-col md:flex-row md:items-baseline gap-8 px-4">
                        <div className="w-32 shrink-0">
                          <span className="text-4xl font-serif italic text-wkbInk/60 blend-ink block">
                            {formatDayMonth(event.date)}
                          </span>
                          <span className="text-xs font-bold text-wkbInk/30 block mt-2">{formatYear(event.date)}</span>
                        </div>
                        <div className="grow">
                          <h3 className="text-2xl md:text-4xl font-serif text-wkbInk/70 mb-2">{event.title}</h3>
                          <p className="text-xs uppercase tracking-widest text-wkbInk/40">{event.subtitle}</p>
                        </div>
                        <div className="w-48 text-right shrink-0">
                          <span className="text-base font-serif italic text-wkbInk/50 block mb-2">{event.location}</span>
                        </div>
                      </div>
                    </div>
                  ))}
                  <div className="border-t border-wkbInk/10"></div>
                </>
              )}
            </div>
          </div>
        );
      };

      const App = () => {
        // Intro State to fix the "gone" issue
        const [introPlayed, setIntroPlayed] = useState(false);
        
        const initialView = previewMode === 'page'
          ? (previewPayload?.data?.slug || 'page')
          : (previewMode ? previewMode : getPageFromPath());
        const [view, setView] = useState(initialView);
        
        const handleSetView = (newView) => {
          setView(newView);
          if (!previewMode) {
            const url = newView === 'home' ? basePath : `${basePath}${newView}`;
            window.history.pushState({ view: newView }, '', url);
          }
        };

        useEffect(() => {
          const handlePopState = (event) => {
            if (event.state && event.state.view) {
              setView(event.state.view);
            } else {
              setView(getPageFromPath());
            }
          };
          window.addEventListener('popstate', handlePopState);
          return () => window.removeEventListener('popstate', handlePopState);
        }, []);

        const [contentPages, setContentPages] = useState({});
        const [pages, setPages] = useState([]);
        const [members, setMembers] = useState([]);
        const [collaborators, setCollaborators] = useState([]);

        useEffect(() => {
          let alive = true;
          const loadContent = async () => {
            try {
              const [pagesRes, membersRes, collaboratorsRes] = await Promise.all([
                supabaseClient.from('content_pages').select('slug,title,data'),
                supabaseClient.from('members').select('*').order('sort_order', { ascending: true }),
                supabaseClient.from('collaborators').select('*').order('sort_order', { ascending: true })
              ]);

              if (!alive) return;

              const pageMap = {};
              (pagesRes.data || []).forEach((page) => {
                pageMap[page.slug] = page.data || {};
              });
              setContentPages(pageMap);

              if (!(previewMode === 'page' && previewPayload?.type === 'page')) {
                const pageList = (pagesRes.data || []).filter((p) => p.data && p.data.page_type === 'page');
                setPages(pageList);
              }

              if (!(previewMode === 'about' && previewPayload?.type === 'members')) {
                if (membersRes.data && membersRes.data.length) {
                  setMembers(membersRes.data.map((m) => ({
                    name: m.name,
                    instrument: m.instrument,
                    imageUrl: m.image_url
                  })));
                }
              }

              if (collaboratorsRes.data && collaboratorsRes.data.length) {
                setCollaborators(collaboratorsRes.data.map((c) => c.name));
              }
            } catch (err) {
              console.error(err);
            }
          };

          loadContent();
          return () => { alive = false; };
        }, []);

        useEffect(() => {
          if (previewMode === 'page' && previewPayload?.type === 'page') {
            setPages([{ slug: previewPayload.data.slug || 'page', title: previewPayload.data.title, data: previewPayload.data }]);
          }
        }, []);

        const homeContent = contentPages.home || DEFAULT_HOME_CONTENT;
        const aboutContent = contentPages.about || DEFAULT_ABOUT_CONTENT;
        const plusContent = mergePlusContent(contentPages.plus);
        const footerContent = contentPages.footer || DEFAULT_FOOTER_CONTENT;
        const currentPage = (pages || []).find((p) => p.slug === view);

        return (
          <main className="relative w-full min-h-screen bg-wkbPaper">
            <SEOManager view={view} />
            <div className="noise"></div>
            <Spotlight />
            <AudioPlayer />
            
            <div className="relative z-10">
              {/* INTRO SEQUENCE LOGIC FIX */}
              {!previewMode && view === 'home' && !introPlayed && (
                <IntroSequence onComplete={() => setIntroPlayed(true)} />
              )}

              {/* CONTENT LOGIC FIX: Show if Preview Mode OR Intro Played OR NOT Home */}
              {(previewMode || introPlayed || view !== 'home') && (
                <>
                  <Navigation currentView={view} setView={handleSetView} pages={pages} />
                  {view === 'home' && <HomeSection setView={handleSetView} homeContent={homeContent} collaborators={collaborators} />}
                  {view === 'news' && <NewsSection />}
                  {view === 'about' && <AboutSection aboutContent={aboutContent} members={members} />}
                  {view === 'plus' && <PlusSection plusContent={plusContent} />}
                  {view === 'calendar' && <CalendarSection />}
                  {currentPage && <BuilderPage page={currentPage} members={members} plusContent={plusContent} />}
                  <Footer footerContent={footerContent} />
                </>
              )}
            </div>
          </main>
        );
      };

            const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>
